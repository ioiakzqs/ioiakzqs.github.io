<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"example.com",root:"/",scheme:"Gemini",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"mac"},back2top:{enable:!0,sidebar:!0,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.json"}</script><meta name="description" content="由于莫队是一种毒瘤的数据结构，而且最近一直在练莫队的扩展，所以就把练习的题目放到这里面。 还没更完，咕。"><meta property="og:type" content="article"><meta property="og:title" content="莫队总结"><meta property="og:url" content="http://example.com/2021/06/13/modui-summary/index.html"><meta property="og:site_name" content="zqs&#96;s blog"><meta property="og:description" content="由于莫队是一种毒瘤的数据结构，而且最近一直在练莫队的扩展，所以就把练习的题目放到这里面。 还没更完，咕。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://i.loli.net/2021/06/13/fXwknNJTuyC48FW.png"><meta property="og:image" content="https://i.loli.net/2021/06/13/fXwknNJTuyC48FW.png"><meta property="article:published_time" content="2021-06-13T04:10:57.000Z"><meta property="article:modified_time" content="2021-06-14T05:35:48.784Z"><meta property="article:author" content="zqs菜鸡"><meta property="article:tag" content="莫队"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://i.loli.net/2021/06/13/fXwknNJTuyC48FW.png"><link rel="canonical" href="http://example.com/2021/06/13/modui-summary/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>莫队总结 | zqs`s blog</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div> <a target="_blank" rel="noopener" href="https://github.com/ioiakzqs" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#70b7fd;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">zqs`s blog</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">有朋自远方来，虽远必诛</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2021/06/13/modui-summary/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="zqs菜鸡"><meta itemprop="description" content="反正是个菜鸡"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="zqs`s blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 莫队总结</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-06-13 12:10:57" itemprop="dateCreated datePublished" datetime="2021-06-13T12:10:57+08:00">2021-06-13</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2021-06-14 13:35:48" itemprop="dateModified" datetime="2021-06-14T13:35:48+08:00">2021-06-14</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">数据结构</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span> <span class="post-meta-item-text">Valine：</span><a title="valine" href="/2021/06/13/modui-summary/#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2021/06/13/modui-summary/" itemprop="commentCount"></span></a></span></div></header><div class="post-body" itemprop="articleBody"><p>由于莫队是一种毒瘤的数据结构，而且最近一直在练莫队的扩展，所以就把练习的题目放到这里面。</p><p>还没更完，咕。</p><span id="more"></span><h1 id="带修莫队"><a href="#带修莫队" class="headerlink" title="带修莫队"></a>带修莫队</h1><h2 id="P1903-国家集训队-数颜色-维护队列"><a href="#P1903-国家集训队-数颜色-维护队列" class="headerlink" title="P1903 [国家集训队]数颜色 / 维护队列"></a><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P1903">P1903 [国家集训队]数颜色 / 维护队列</a></h2><p><del>小Z的袜子也是国家集训队，是不是国家集训队都喜欢出莫队板子啊（大雾</del></p><p>个人认为本文提到的莫队的三种扩展中最容易理解，代码最好写的。</p><p>对于每个询问除左右端点 $l,r$ 外记录一个 $t$ 表示这个询问之间有几次修改。</p><p>把每个询问按照左端点所在块号为第一关键字，右端点块号为第二关键字，$t$ 为第三关键字排序。</p><p>普通莫队的话询问 $[l,r]$ 可以转移到 $[l-1,r],[l,r-1],[l+1,r],[l,r+1]$，多了时间维 $t$ 可以转移到 $[l-1,r,t],[l,r-1,t],[l+1,r,t],[l,r+1,t],[l,r,t-1],[l,r,t+1]$。</p><p>按照时间轴撤销/进行修改操作。每次修改维护原数组，如果修改的点在当前区间内进行一次 add 和 del。</p><p>块长取 $O(n^{2/3})$ 可以做到 $O(n^{5/3})$ 的理论上不如暴力的效率（考虑常数，$n,m$ 同阶）。然而众所周知莫队肥肠玄学，所以就过了（</p><p>其实带修莫队相当于三维询问的莫队，对于 $k$ 维的询问，可以用类似的方法做到 $O(n^{2k-1/k})$ 的复杂度（这个复杂度很假，我们要相信莫队的玄学（大雾））。</p><div><div class="fold_hider"><div class="close hider_title">代码</div></div><div class="fold"><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cmath&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> n, m, S, a[<span class="number">150005</span>], ans[<span class="number">150005</span>], Old[<span class="number">150005</span>], New[<span class="number">150005</span>];</span><br><span class="line"><span class="keyword">int</span> p[<span class="number">150005</span>], cnt[<span class="number">1000005</span>], b[<span class="number">150005</span>], now, Q;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Quest</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> l, r, t, id;</span><br><span class="line">	<span class="keyword">inline</span> <span class="keyword">bool</span> <span class="keyword">operator</span> &lt; (<span class="keyword">const</span> Quest a) <span class="keyword">const</span> &#123;</span><br><span class="line">		<span class="keyword">int</span> lb = (l - <span class="number">1</span>) / S, lb2 = (a.l - <span class="number">1</span>) / S, rb = (r - <span class="number">1</span>) / S, rb2 = (a.r - <span class="number">1</span>) / S;</span><br><span class="line">		<span class="keyword">return</span> lb == lb2 ? (rb == rb2 ? t &lt; a.t : rb &lt; rb2) : lb &lt; lb2;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; q[<span class="number">150005</span>];</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;<span class="keyword">if</span> ((++ cnt[x]) == <span class="number">1</span>) ++ now;&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">del</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;<span class="keyword">if</span> (!(-- cnt[x])) -- now;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> l = <span class="number">1</span>, r = <span class="number">0</span>, t = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%d%d&quot;</span>, &amp;n, &amp;m);</span><br><span class="line">	S = <span class="built_in">pow</span>(n, <span class="number">2.0</span> / <span class="number">3.0</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++ i) <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, a + i), b[i] = a[i];</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>, j = <span class="number">0</span>; i &lt;= m; ++ i) &#123;</span><br><span class="line">		<span class="keyword">int</span> l, r;</span><br><span class="line">		<span class="keyword">char</span> opt;</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot; %c%d%d&quot;</span>, &amp;opt, &amp;l, &amp;r);</span><br><span class="line">		<span class="keyword">if</span> (opt == <span class="string">&#x27;R&#x27;</span>) Old[++ j] = b[l], New[j] = r, b[l] = r, p[j] = l;p[j]记录第j次修改的位置</span><br><span class="line">		<span class="keyword">else</span> q[++ Q].l = l, q[Q].r = r, q[Q].t = j, q[Q].id = Q;</span><br><span class="line">	&#125;</span><br><span class="line">	std::<span class="built_in">sort</span>(q + <span class="number">1</span>, q + Q + <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= Q; ++ i) &#123;</span><br><span class="line">		<span class="keyword">while</span> (l &gt; q[i].l) <span class="built_in">add</span>(a[-- l]);</span><br><span class="line">		<span class="keyword">while</span> (r &lt; q[i].r) <span class="built_in">add</span>(a[++ r]);</span><br><span class="line">		<span class="keyword">while</span> (l &lt; q[i].l) <span class="built_in">del</span>(a[l ++]);</span><br><span class="line">		<span class="keyword">while</span> (r &gt; q[i].r) <span class="built_in">del</span>(a[r --]);</span><br><span class="line">		<span class="keyword">while</span> (t &lt; q[i].t) &#123;</span><br><span class="line">			++ t;</span><br><span class="line">			<span class="keyword">if</span> (l &lt;= p[t] &amp;&amp; p[t] &lt;= r) <span class="built_in">del</span>(a[p[t]]), <span class="built_in">add</span>(New[t]);<span class="comment">//进行修改操作，考虑对答案的影响。</span></span><br><span class="line">			a[p[t]] = New[t];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">while</span> (t &gt; q[i].t) &#123;</span><br><span class="line">			<span class="keyword">if</span> (l &lt;= p[t] &amp;&amp; p[t] &lt;= r) <span class="built_in">del</span>(a[p[t]]), <span class="built_in">add</span>(Old[t]);<span class="comment">//撤销修改。</span></span><br><span class="line">			a[p[t]] = Old[t], -- t;</span><br><span class="line">		&#125;</span><br><span class="line">		ans[q[i].id] = now;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= Q; ++ i) <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, ans[i]);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></div><h1 id="树上莫队"><a href="#树上莫队" class="headerlink" title="树上莫队"></a>树上莫队</h1><h2 id="SP10707-COT2-Count-on-a-tree-II"><a href="#SP10707-COT2-Count-on-a-tree-II" class="headerlink" title="SP10707 COT2 - Count on a tree II"></a><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/SP10707">SP10707 COT2 - Count on a tree II</a></h2><p>其实这个世界上莫队本来上不了树，把树转成序列，莫队就上了树（雾</p><p>一个很自然的想法是把 $u\rightarrow v$ 的路径转为 $u\rightarrow lca,lca\rightarrow v$ 两条路径。</p><p>dfs 序尝试发现没救，我们考虑欧拉序，记一个点第一次在欧拉序出现的位置 $fst[u]$，第二次出现的位置 $lst[u]$。</p><p>我们默认 $fst[u]&lt;fst[v]$。</p><p>分情况讨论：</p><ol><li>$u=lca$。那么这时候对应欧拉序 $[fst[u],fst[v]]$ 这一段区间<strong>只出现一次的点</strong>。</li><li>$u\ne lca$。对应 $[lst[u],fst[v]]$ 这段区间内只出现一次的点。而 $lca$ 没有在这段区间出现，因此我们还要特判 $lca$。</li></ol><p>至于为什么读者自证不难。</p><p>由于这题调的时候心态炸掉所以变量名有些儒雅随和（逃</p><div><div class="fold_hider"><div class="close hider_title">代码</div></div><div class="fold"><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cmath&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fst[<span class="number">100005</span>], lst[<span class="number">100005</span>], a[<span class="number">100005</span>], c[<span class="number">200005</span>], d[<span class="number">200005</span>], S;</span><br><span class="line"><span class="keyword">int</span> cnt, Cnt[<span class="number">100005</span>], Cnt2[<span class="number">100005</span>], id, now, ans[<span class="number">100005</span>], fa[<span class="number">100005</span>][<span class="number">19</span>], dep[<span class="number">100005</span>];</span><br><span class="line"><span class="keyword">int</span> nmsl[<span class="number">100005</span>];</span><br><span class="line">std::map&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; mp;<span class="comment">//离散化</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Edge</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> to, nxt;</span><br><span class="line">&#125; e[<span class="number">200005</span>];</span><br><span class="line"><span class="keyword">int</span> head[<span class="number">100005</span>], tot;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">AddEdge</span><span class="params">(<span class="keyword">int</span> u, <span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">	e[++ tot].to = v, e[tot].nxt = head[u], head[u] = tot;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Quest</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> l, r, lca, id;</span><br><span class="line">	<span class="keyword">inline</span> <span class="keyword">bool</span> <span class="keyword">operator</span> &lt; (<span class="keyword">const</span> Quest x) &#123;</span><br><span class="line">		<span class="keyword">return</span> (l - <span class="number">1</span>) / S == (x.l - <span class="number">1</span>) / S ? r &lt; x.r : (l - <span class="number">1</span>) / S &lt; (x.l - <span class="number">1</span>) / S;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; q[<span class="number">100005</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span> u)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">18</span>; ++ i) fa[u][i] = fa[fa[u][i - <span class="number">1</span>]][i - <span class="number">1</span>];</span><br><span class="line">	dep[u] = dep[fa[u][<span class="number">0</span>]] + <span class="number">1</span>, fst[u] = ++ cnt, d[cnt] = u;</span><br><span class="line">	<span class="keyword">int</span> t;</span><br><span class="line">	<span class="keyword">if</span> (!mp.<span class="built_in">count</span>(a[u])) t = mp[a[u]] = ++ id;</span><br><span class="line">	<span class="keyword">else</span> t = mp[a[u]];</span><br><span class="line">	c[cnt] = nmsl[u] = t;<span class="comment">//nmsl[u]记点u离散化后的值</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = head[u]; i; i = e[i].nxt)</span><br><span class="line">		<span class="keyword">if</span> (e[i].to != fa[u][<span class="number">0</span>]) fa[e[i].to][<span class="number">0</span>] = u, <span class="built_in">dfs</span>(e[i].to);</span><br><span class="line">	lst[u] = ++ cnt, d[cnt] = u, c[cnt] = t;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> u, <span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (dep[u] &lt; dep[v]) u ^= v ^= u ^= v;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">18</span>; ++ i)</span><br><span class="line">		<span class="keyword">if</span> (dep[u] - dep[v] &amp; <span class="number">1</span> &lt;&lt; i) u = fa[u][i];</span><br><span class="line">	<span class="keyword">if</span> (u == v) <span class="keyword">return</span> u;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">18</span>; i &gt;= <span class="number">0</span>; -- i)</span><br><span class="line">		<span class="keyword">if</span> (fa[u][i] != fa[v][i]) u = fa[u][i], v = fa[v][i];</span><br><span class="line">	<span class="keyword">return</span> fa[u][<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">shabi</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">	Cnt2[d[x]] ^= <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span> (Cnt2[d[x]] &amp;&amp; ++ Cnt[c[x]] == <span class="number">1</span>) ++ now;</span><br><span class="line">	<span class="keyword">if</span> (!Cnt2[d[x]] &amp;&amp; !(-- Cnt[c[x]])) -- now;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> n, m, l = <span class="number">1</span>, r = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%d%d&quot;</span>, &amp;n, &amp;m);</span><br><span class="line">	S = <span class="number">2</span> * n / <span class="built_in">sqrt</span>(m);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++ i) <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, a + i);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; ++ i) &#123;</span><br><span class="line">		<span class="keyword">int</span> u, v;</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%d%d&quot;</span>, &amp;u, &amp;v);</span><br><span class="line">		<span class="built_in">AddEdge</span>(u, v), <span class="built_in">AddEdge</span>(v, u);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">dfs</span>(<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; ++ i) &#123;</span><br><span class="line">		<span class="keyword">int</span> u, v, lca;</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%d%d&quot;</span>, &amp;u, &amp;v);</span><br><span class="line">		<span class="keyword">if</span> (fst[u] &gt; fst[v]) u ^= v ^= u ^= v;</span><br><span class="line">		lca = <span class="built_in">query</span>(u, v), q[i].id = i, q[i].lca = lca;</span><br><span class="line">		<span class="keyword">if</span> (lca == u) q[i].l = fst[u], q[i].r = fst[v];</span><br><span class="line">		<span class="keyword">else</span> q[i].l = lst[u], q[i].r = fst[v];</span><br><span class="line">	&#125;</span><br><span class="line">	std::<span class="built_in">sort</span>(q + <span class="number">1</span>, q + m + <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; ++ i) &#123;</span><br><span class="line">		<span class="keyword">while</span> (r &lt; q[i].r) <span class="built_in">shabi</span>(++ r);</span><br><span class="line">		<span class="keyword">while</span> (r &gt; q[i].r) <span class="built_in">shabi</span>(r --);</span><br><span class="line">		<span class="keyword">while</span> (l &lt; q[i].l) <span class="built_in">shabi</span>(l ++);</span><br><span class="line">		<span class="keyword">while</span> (l &gt; q[i].l) <span class="built_in">shabi</span>(-- l);</span><br><span class="line">		ans[q[i].id] = now + (Cnt[nmsl[q[i].lca]] == <span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; ++ i) <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, ans[i]);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></div><h1 id="回滚莫队"><a href="#回滚莫队" class="headerlink" title="回滚莫队"></a>回滚莫队</h1><p>一听名字就感觉它比前两种莫队高端，然而实际上它就是个不需要删除操作的莫队（没有 del 函数）。</p><h2 id="AT1219-歴史の研究"><a href="#AT1219-歴史の研究" class="headerlink" title="AT1219 歴史の研究"></a><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/AT1219">AT1219 歴史の研究</a></h2><p>加权区间众数是个经典的问题。如果用莫队解决删除操作似乎很麻烦（其实普通莫队可以做，但重点不在这里）。</p><p>回滚莫队就专门解决这种删除麻烦的情况。设一个块长 $S$。</p><p>对于询问区间长度小于 $S$ 的询问我们直接暴力。</p><p>对于询问区间长度大于 $S$ 的询问我们把他们按左端点所在块号为第一关键字，右端点为第二关键字排序。</p><p>然后一口气把左端点落在同一个块里的询问处理完。</p><p>如下图，假设我们处理了绿色区间的询问，下一个要处理的是红色区间（$p$ 代表这两个区间左端点所在块的右端点）。</p><p><img src="https://i.loli.net/2021/06/13/fXwknNJTuyC48FW.png" alt="1145141919810.png"></p><p>右端点 $r$ 由于是排好序的直接向右添加即可，但左端点如果 $l[1]\ge l[2]$ 那还好，可 $l[1]&lt;l[2]$ 就不可避免地要删除，怎么办？</p><p>这个时候回滚莫队说，直接把左端点 $l$ 从 $l[1]$ 移到 $p$，再把 $l$ 从 $p$ 移到 $l[2]$。</p><p>那把左端点从 $l[1]$ 移到 $p$ 还不是要删除？</p><p>但我们可以提前记录下 $[p,r[1]]$ 这段区间的答案 $lst$，然后直接删除数字即可，不需要修改答案。这样删除就是 $O(1)$ 的了。</p><p>然后调整 $l$ 到 $p$ 后再调整右端点，加入 $[r[1]+1,r[2]]$ 之间的元素，更新 $lst$ 为 $[p,r[2]$ 区间的答案。最后再移动左端点 $l$ 到 $l[2]$，得到当前询问的答案。</p><p>时间复杂度：若块长为 $S$，那么左端点移动就是 $O(mS)$ 的，右端点是 $O(n^2/S)$ 的，$S$ 取 $n\div \sqrt{m}$ 可以获得 $O(n\sqrt{m})$ 的优秀复杂度。</p><div><div class="fold_hider"><div class="close hider_title">代码</div></div><div class="fold"><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cmath&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> int long long</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">max</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> x, <span class="keyword">const</span> <span class="keyword">int</span> y)</span> </span>&#123;<span class="keyword">return</span> x &gt; y ? x : y;&#125;</span><br><span class="line">std::map&lt;<span class="keyword">int</span>, <span class="keyword">int</span>&gt; mp;</span><br><span class="line"><span class="keyword">int</span> a[<span class="number">100005</span>], x[<span class="number">100005</span>], ans[<span class="number">100005</span>], cnt[<span class="number">100005</span>], cnt2[<span class="number">100005</span>], S, id, now;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Quest</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> l, r, id;</span><br><span class="line">	<span class="keyword">inline</span> <span class="keyword">bool</span> <span class="keyword">operator</span> &lt; (<span class="keyword">const</span> Quest x) <span class="keyword">const</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> (l - <span class="number">1</span>) / S == (x.l - <span class="number">1</span>) / S ? r &lt; x.r : (l - <span class="number">1</span>) / S &lt; (x.l - <span class="number">1</span>) / S;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; q[<span class="number">100005</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">signed</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> n, m;</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%lld%lld&quot;</span>, &amp;n, &amp;m);</span><br><span class="line">	S = n / <span class="built_in">sqrt</span>(m);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++ i) <span class="built_in">scanf</span>(<span class="string">&quot;%lld&quot;</span>, x + i);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++ i)</span><br><span class="line">		<span class="keyword">if</span> (!mp.<span class="built_in">count</span>(x[i])) a[i] = mp[x[i]] = ++ id;</span><br><span class="line">		<span class="keyword">else</span> a[i] = mp[x[i]];</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; ++ i)</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%lld%lld&quot;</span>, &amp;q[i].l, &amp;q[i].r), q[i].id = i;</span><br><span class="line">	std::<span class="built_in">sort</span>(q + <span class="number">1</span>, q + m + <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m;) &#123;</span><br><span class="line">		<span class="keyword">int</span> blk = (q[i].l - <span class="number">1</span>) / S + <span class="number">1</span>, l = blk * S + <span class="number">1</span>, r = blk * S, lst = <span class="number">0</span>;</span><br><span class="line">		<span class="built_in">memset</span>(cnt, <span class="number">0</span>, <span class="keyword">sizeof</span> cnt);</span><br><span class="line">		<span class="keyword">for</span> (; i &lt;= m &amp;&amp; blk == (q[i].l - <span class="number">1</span>) / S + <span class="number">1</span>; ++ i) &#123;<span class="comment">//一口气处理左端点在一个块里的询问</span></span><br><span class="line">			<span class="keyword">if</span> (q[i].r &lt;= blk * S) &#123;<span class="comment">//直接暴力</span></span><br><span class="line">				<span class="keyword">int</span> now = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> k = q[i].l; k &lt;= q[i].r; ++ k) cnt2[a[k]] = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> k = q[i].l; k &lt;= q[i].r; ++ k)</span><br><span class="line">					now = <span class="built_in">max</span>(now, x[k] * (++ cnt2[a[k]]));</span><br><span class="line">				ans[q[i].id] = now;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">while</span> (l &lt;= blk * S) -- cnt[a[l ++]];<span class="comment">//回滚左端点到p</span></span><br><span class="line">				now = lst;</span><br><span class="line">				<span class="keyword">while</span> (r &lt; q[i].r) ++ r, now = <span class="built_in">max</span>(now, x[r] * (++ cnt[a[r]]));<span class="comment">//调整右端点，更新lst</span></span><br><span class="line">				lst = now;</span><br><span class="line">				<span class="keyword">while</span> (l &gt; q[i].l) -- l, now = <span class="built_in">max</span>(now, x[l] * (++ cnt[a[l]]));<span class="comment">//调整左端点</span></span><br><span class="line">				ans[q[i].id] = now;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; ++ i) <span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>, ans[i]);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></div><h2 id="BZOJ4358-permu"><a href="#BZOJ4358-permu" class="headerlink" title="BZOJ4358 permu"></a>BZOJ4358 permu</h2><p>求 $[l,r]$ 区间最长连续段很容易想到用并查集。</p><p>具体的，若存在数字 $k$，则 $k,k+1$ 应在一个集合里。最终的答案就是节点数最多的集合的节点数减一。</p><p>但是现在问题来了：如果仍然上回滚莫队，我们如何撤销并查集的操作？</p><p>把那张图再放一遍：</p><p><img src="https://i.loli.net/2021/06/13/fXwknNJTuyC48FW.png" alt="1145141919810.png"></p><p>我们想要撤销 $[l[1],p]$ 的并查集操作。</p><p>因此无法路径压缩，这里我选择启发式合并，按秩合并少一个 $\log$ 但代码长一些。</p><p>在加入 $[l[1],p]$ 中的元素合并并查集时，我们把每次把并查集中节点数小的那个集合合并到节点数大的那一个去。所以我们把这些节点数小的 push 到一个栈中，然后弹出栈顶依次撤销。</p><p>为什么要用一个栈而非队列？用队列会让某些节点的子节点数撤销后比原来大！</p><p>复杂度 $O(n\sqrt{m}\log n)$。由于并查集的玄学和常数极小&amp;数据规模本来就小所以跑得飞快。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cmath&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">max</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> x, <span class="keyword">const</span> <span class="keyword">int</span> y)</span> </span>&#123;<span class="keyword">return</span> x &gt; y ? x : y;&#125;</span><br><span class="line"><span class="keyword">int</span> fa[<span class="number">50005</span>], a[<span class="number">50005</span>], ans[<span class="number">50005</span>], sze[<span class="number">50005</span>], s[<span class="number">50005</span>], top, n, m, S, now;</span><br><span class="line"><span class="keyword">int</span> fa2[<span class="number">50005</span>], sz2[<span class="number">50005</span>];</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Quest</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> l, r, id;</span><br><span class="line">	<span class="keyword">inline</span> <span class="keyword">bool</span> <span class="keyword">operator</span> &lt; (<span class="keyword">const</span> Quest a) <span class="keyword">const</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> (l - <span class="number">1</span>) / S == (a.l - <span class="number">1</span>) / S ? r &lt; a.r : (l - <span class="number">1</span>) / S &lt; (a.l - <span class="number">1</span>) / S;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; q[<span class="number">50005</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">find</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;<span class="keyword">return</span> fa[x] == x ? x : <span class="built_in">find</span>(fa[x]);&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">merge</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">bool</span> flag = <span class="literal">false</span>)</span> </span>&#123;</span><br><span class="line">	x = <span class="built_in">find</span>(x), y = <span class="built_in">find</span>(y);</span><br><span class="line">	<span class="keyword">if</span> (x == y) <span class="keyword">return</span>;</span><br><span class="line">	<span class="keyword">if</span> (sze[x] &lt; sze[y]) x ^= y ^= x ^= y;</span><br><span class="line">	fa[y] = x, now = <span class="built_in">max</span>(now, (sze[x] += sze[y]) - <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span> (flag) s[++ top] = y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%d%d&quot;</span>, &amp;n, &amp;m);</span><br><span class="line">	S = n / <span class="built_in">sqrt</span>(m);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++ i) <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, a + i);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; ++ i) <span class="built_in">scanf</span>(<span class="string">&quot;%d%d&quot;</span>, &amp;q[i].l, &amp;q[i].r), q[i].id = i;</span><br><span class="line">	std::<span class="built_in">sort</span>(q + <span class="number">1</span>, q + m + <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m;) &#123;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= n + <span class="number">1</span>; ++ j) fa[j] = j, sze[j] = <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= n + <span class="number">1</span>; ++ j) fa2[j] = j, sz2[j] = <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">int</span> blk = (q[i].l - <span class="number">1</span>) / S + <span class="number">1</span>, l = blk * S + <span class="number">1</span>, r = blk * S, lst = <span class="number">0</span>;</span><br><span class="line">		top = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span> (; (q[i].l - <span class="number">1</span>) / S + <span class="number">1</span> == blk; ++ i) &#123;</span><br><span class="line">			<span class="keyword">if</span> (q[i].r &lt;= blk * S) &#123;</span><br><span class="line">				now = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> k = q[i].l; k &lt;= q[i].r; ++ k) <span class="built_in">merge</span>(a[k], a[k] + <span class="number">1</span>);</span><br><span class="line">				ans[q[i].id] = now;</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> k = q[i].l; k &lt;= q[i].r; ++ k)</span><br><span class="line">					fa[a[k]] = a[k], sze[a[k]] = sze[a[k] + <span class="number">1</span>] = <span class="number">1</span>, fa[a[k] + <span class="number">1</span>] = a[k] + <span class="number">1</span>;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				l = blk * S + <span class="number">1</span>;</span><br><span class="line">				<span class="keyword">while</span> (top) &#123;</span><br><span class="line">					sze[fa[s[top]]] -= sze[s[top]];</span><br><span class="line">					fa[s[top]] = s[top];</span><br><span class="line">					-- top;</span><br><span class="line">				&#125;</span><br><span class="line">				now = lst;</span><br><span class="line">				<span class="keyword">while</span> (r &lt; q[i].r) ++ r, <span class="built_in">merge</span>(a[r], a[r] + <span class="number">1</span>);</span><br><span class="line">				lst = now;</span><br><span class="line">				<span class="keyword">while</span> (l &gt; q[i].l) -- l, <span class="built_in">merge</span>(a[l], a[l] + <span class="number">1</span>, <span class="literal">true</span>);</span><br><span class="line">				ans[q[i].id] = now;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; ++ i) <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>, ans[i]);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="莫队综合"><a href="#莫队综合" class="headerlink" title="莫队综合"></a>莫队综合</h1><h2 id="P4074-WC2013-糖果公园"><a href="#P4074-WC2013-糖果公园" class="headerlink" title="P4074 [WC2013] 糖果公园"></a><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P4074">P4074 [WC2013] 糖果公园</a></h2><p>树上带修莫队板子。写起来那是相当的恶心，而且我的代码uoj，校内oj，本地均AC，洛谷boom0很离谱。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cmath&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> int long long</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> fst[<span class="number">100005</span>], lst[<span class="number">100005</span>], a[<span class="number">100005</span>], b[<span class="number">200005</span>], pre[<span class="number">100005</span>], S;</span><br><span class="line"><span class="keyword">int</span> cnt, Cnt[<span class="number">100005</span>], Cnt2[<span class="number">100005</span>], id, now, ans[<span class="number">100005</span>], fa[<span class="number">100005</span>][<span class="number">19</span>], dep[<span class="number">100005</span>];</span><br><span class="line"><span class="keyword">int</span> v[<span class="number">100005</span>], w[<span class="number">100005</span>], Old[<span class="number">200005</span>], New[<span class="number">200005</span>], p[<span class="number">100005</span>];</span><br><span class="line"><span class="keyword">int</span> l = <span class="number">1</span>, r, t;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Edge</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> to, nxt;</span><br><span class="line">&#125; e[<span class="number">200005</span>];</span><br><span class="line"><span class="keyword">int</span> head[<span class="number">100005</span>], tot;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">AddEdge</span><span class="params">(<span class="keyword">int</span> u, <span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">	e[++ tot].to = v, e[tot].nxt = head[u], head[u] = tot;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Quest</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> l, r, lca, id, t;</span><br><span class="line">	<span class="keyword">inline</span> <span class="keyword">bool</span> <span class="keyword">operator</span> &lt; (<span class="keyword">const</span> Quest x) <span class="keyword">const</span> &#123;</span><br><span class="line">		<span class="keyword">int</span> lb = (l - <span class="number">1</span>) / S, lb2 = (x.l - <span class="number">1</span>) / S, rb = (r - <span class="number">1</span>) / S, rb2 = (x.r - <span class="number">1</span>) / S;</span><br><span class="line">		<span class="keyword">return</span> lb == lb2 ? (rb == rb2 ? t &lt; x.t : rb &lt; rb2) : lb &lt; lb2;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; q[<span class="number">100005</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span> u)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="number">18</span>; ++ i) fa[u][i] = fa[fa[u][i - <span class="number">1</span>]][i - <span class="number">1</span>];</span><br><span class="line">	dep[u] = dep[fa[u][<span class="number">0</span>]] + <span class="number">1</span>, fst[u] = ++ cnt, b[cnt] = u;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = head[u]; i; i = e[i].nxt)</span><br><span class="line">		<span class="keyword">if</span> (e[i].to != fa[u][<span class="number">0</span>]) fa[e[i].to][<span class="number">0</span>] = u, <span class="built_in">dfs</span>(e[i].to);</span><br><span class="line">	lst[u] = ++ cnt, b[cnt] = u;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> u, <span class="keyword">int</span> v)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (dep[u] &lt; dep[v]) u ^= v ^= u ^= v;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">18</span>; ++ i)</span><br><span class="line">		<span class="keyword">if</span> (dep[u] - dep[v] &amp; <span class="number">1</span> &lt;&lt; i) u = fa[u][i];</span><br><span class="line">	<span class="keyword">if</span> (u == v) <span class="keyword">return</span> u;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">18</span>; i &gt;= <span class="number">0</span>; -- i)</span><br><span class="line">		<span class="keyword">if</span> (fa[u][i] != fa[v][i]) u = fa[u][i], v = fa[v][i];</span><br><span class="line">	<span class="keyword">return</span> fa[u][<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> c = a[x];</span><br><span class="line">	Cnt2[x] ^= <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span> (!Cnt2[x]) now -= v[c] * w[Cnt[c] --];</span><br><span class="line">	<span class="keyword">if</span> (Cnt2[x] &amp;&amp; ++ Cnt[c] &gt; <span class="number">0</span>) now += v[c] * w[Cnt[c]];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">del</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> c = a[x];</span><br><span class="line">	Cnt2[x] ^= <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span> (!Cnt2[x]) now -= v[c] * w[Cnt[c] --];</span><br><span class="line">	<span class="keyword">if</span> (Cnt2[x] &amp;&amp; ++ Cnt[c] &gt; <span class="number">0</span>) now += v[c] * w[Cnt[c]];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">modify</span><span class="params">(<span class="keyword">int</span> p, <span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (Cnt2[p]) <span class="built_in">del</span>(p), a[p] = x, <span class="built_in">add</span>(p);</span><br><span class="line">	a[p] = x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">signed</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> n, m, Q, qt = <span class="number">0</span>;</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%lld%lld%lld&quot;</span>, &amp;n, &amp;m, &amp;Q);</span><br><span class="line">	S = <span class="built_in">pow</span>(n, <span class="number">2.0</span> / <span class="number">3.0</span>) * <span class="built_in">sqrt</span>(<span class="number">2</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= m; ++ i) <span class="built_in">scanf</span>(<span class="string">&quot;%lld&quot;</span>, v + i);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++ i) <span class="built_in">scanf</span>(<span class="string">&quot;%lld&quot;</span>, w + i);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; n; ++ i) &#123;</span><br><span class="line">		<span class="keyword">int</span> u, v;</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%lld%lld&quot;</span>, &amp;u, &amp;v);</span><br><span class="line">		<span class="built_in">AddEdge</span>(u, v), <span class="built_in">AddEdge</span>(v, u);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++ i) <span class="built_in">scanf</span>(<span class="string">&quot;%lld&quot;</span>, a + i), pre[i] = a[i];</span><br><span class="line">	<span class="built_in">dfs</span>(<span class="number">1</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>, j = <span class="number">0</span>; i &lt;= Q; ++ i) &#123;</span><br><span class="line">		<span class="keyword">int</span> opt;</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%lld&quot;</span>, &amp;opt);</span><br><span class="line">		<span class="keyword">if</span> (opt == <span class="number">1</span>) &#123;</span><br><span class="line">			<span class="keyword">int</span> u, v, lca;</span><br><span class="line">			<span class="built_in">scanf</span>(<span class="string">&quot;%lld%lld&quot;</span>, &amp;u, &amp;v);</span><br><span class="line">			<span class="keyword">if</span> (fst[u] &gt; fst[v]) u ^= v ^= u ^= v;</span><br><span class="line">			lca = <span class="built_in">query</span>(u, v), q[++ qt].id = qt, q[qt].t = j;</span><br><span class="line">			<span class="keyword">if</span> (lca == u) q[qt].l = fst[u], q[qt].r = fst[v];</span><br><span class="line">			<span class="keyword">else</span> q[qt].l = lst[u], q[qt].r = fst[v], q[qt].lca = lca;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">int</span> x, y;</span><br><span class="line">			<span class="built_in">scanf</span>(<span class="string">&quot;%lld%lld&quot;</span>, &amp;x, &amp;y);</span><br><span class="line">			Old[++ j] = pre[x], New[j] = pre[x] = y, p[j] = x;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	std::<span class="built_in">sort</span>(q + <span class="number">1</span>, q + qt + <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= qt; ++ i) &#123;</span><br><span class="line">		<span class="keyword">while</span> (l &gt; q[i].l) <span class="built_in">add</span>(b[-- l]);</span><br><span class="line">		<span class="keyword">while</span> (r &lt; q[i].r) <span class="built_in">add</span>(b[++ r]);</span><br><span class="line">		<span class="keyword">while</span> (r &gt; q[i].r) <span class="built_in">del</span>(b[r --]);</span><br><span class="line">		<span class="keyword">while</span> (l &lt; q[i].l) <span class="built_in">del</span>(b[l ++]);</span><br><span class="line">		<span class="keyword">while</span> (t &lt; q[i].t) ++ t, <span class="built_in">modify</span>(p[t], New[t]);</span><br><span class="line">		<span class="keyword">while</span> (t &gt; q[i].t) <span class="built_in">modify</span>(p[t], Old[t]), t --;</span><br><span class="line">		<span class="keyword">if</span> (q[i].lca) ans[q[i].id] = v[a[q[i].lca]] * w[Cnt[a[q[i].lca]] + <span class="number">1</span>];</span><br><span class="line">		ans[q[i].id] += now;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= qt; ++ i) <span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>, ans[i]);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> zqs菜鸡</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="http://example.com/2021/06/13/modui-summary/" title="莫队总结">http://example.com/2021/06/13/modui-summary/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/%E8%8E%AB%E9%98%9F/" rel="tag"><i class="fa fa-tag"></i> 莫队</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2021/06/04/luogu-P5901/" rel="prev" title="题解 【P5901 [IOI2009]regions】"><i class="fa fa-chevron-left"></i> 题解 【P5901 [IOI2009]regions】</a></div><div class="post-nav-item"> <a href="/2021/06/20/nkoj-8316/" rel="next" title="题解 【NKOJ8136 买酒卖酒】">题解 【NKOJ8136 买酒卖酒】<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="valine-comments"></div><script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B8%A6%E4%BF%AE%E8%8E%AB%E9%98%9F"><span class="nav-number">1.</span> <span class="nav-text">带修莫队</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#P1903-%E5%9B%BD%E5%AE%B6%E9%9B%86%E8%AE%AD%E9%98%9F-%E6%95%B0%E9%A2%9C%E8%89%B2-%E7%BB%B4%E6%8A%A4%E9%98%9F%E5%88%97"><span class="nav-number">1.1.</span> <span class="nav-text">P1903 [国家集训队]数颜色 &#x2F; 维护队列</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A0%91%E4%B8%8A%E8%8E%AB%E9%98%9F"><span class="nav-number">2.</span> <span class="nav-text">树上莫队</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SP10707-COT2-Count-on-a-tree-II"><span class="nav-number">2.1.</span> <span class="nav-text">SP10707 COT2 - Count on a tree II</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9E%E6%BB%9A%E8%8E%AB%E9%98%9F"><span class="nav-number">3.</span> <span class="nav-text">回滚莫队</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#AT1219-%E6%AD%B4%E5%8F%B2%E3%81%AE%E7%A0%94%E7%A9%B6"><span class="nav-number">3.1.</span> <span class="nav-text">AT1219 歴史の研究</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BZOJ4358-permu"><span class="nav-number">3.2.</span> <span class="nav-text">BZOJ4358 permu</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%8E%AB%E9%98%9F%E7%BB%BC%E5%90%88"><span class="nav-number">4.</span> <span class="nav-text">莫队综合</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#P4074-WC2013-%E7%B3%96%E6%9E%9C%E5%85%AC%E5%9B%AD"><span class="nav-number">4.1.</span> <span class="nav-text">P4074 [WC2013] 糖果公园</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">zqs菜鸡</p><div class="site-description" itemprop="description">反正是个菜鸡</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">61</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">13</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">34</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/ioiakzqs" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ioiakzqs" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="https://gitee.com/zqs2020" title="Gitee → https:&#x2F;&#x2F;gitee.com&#x2F;zqs2020" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> Gitee</a></span><span class="links-of-author-item"><a href="https://blog.csdn.net/jvruo_shabi" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;jvruo_shabi" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i> CSDN</a></span><span class="links-of-author-item"><a href="https://www.luogu.com.cn/user/361308" title="洛谷 → https:&#x2F;&#x2F;www.luogu.com.cn&#x2F;user&#x2F;361308" rel="noopener" target="_blank"><i class="fa fa-fw fa-code"></i> 洛谷</a></span></div><div class="cc-license motion-element" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a></div><div style=""><canvas id="canvas" style="width:60%">当前浏览器不支持canvas，请更换浏览器后再试</canvas></div><script>!function(){var t,o=[[[0,0,1,1,1,0,0],[0,1,1,0,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,0,1,1,0],[0,0,1,1,1,0,0]],[[0,0,0,1,1,0,0],[0,1,1,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[1,1,1,1,1,1,1]],[[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,0,1,1,0,0,0],[0,1,1,0,0,0,0],[1,1,0,0,0,0,0],[1,1,0,0,0,1,1],[1,1,1,1,1,1,1]],[[1,1,1,1,1,1,1],[0,0,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,0,1,1,0],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[0,0,0,0,1,1,0],[0,0,0,1,1,1,0],[0,0,1,1,1,1,0],[0,1,1,0,1,1,0],[1,1,0,0,1,1,0],[1,1,1,1,1,1,1],[0,0,0,0,1,1,0],[0,0,0,0,1,1,0],[0,0,0,0,1,1,0],[0,0,0,1,1,1,1]],[[1,1,1,1,1,1,1],[1,1,0,0,0,0,0],[1,1,0,0,0,0,0],[1,1,1,1,1,1,0],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[0,0,0,0,1,1,0],[0,0,1,1,0,0,0],[0,1,1,0,0,0,0],[1,1,0,0,0,0,0],[1,1,0,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[1,1,1,1,1,1,1],[1,1,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,1,1,0,0,0],[0,0,1,1,0,0,0],[0,0,1,1,0,0,0],[0,0,1,1,0,0,0]],[[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,1,1,0,0,0,0]],[[0,0,0,0,0,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,0,0,0,0]]],e=document.getElementById("canvas");if(e.getContext){var l=e.getContext("2d");e.height=100,e.width=700,l.fillStyle="#f00",l.fillRect(10,10,50,50);var r=[],f=[],i=e.height/20-1;function n(t,e){for(var n=0;n<o[e].length;n++)for(var a=0;a<o[e][n].length;a++)1==o[e][n][a]&&(l.beginPath(),l.arc(14*(i+2)*t+2*a*(i+1)+(i+1),2*n*(i+1)+(i+1),i,0,2*Math.PI),l.closePath(),l.fill())}function h(t,e){for(var n=[1,2,3],a=["#3BE","#09C","#A6C","#93C","#9C0","#690","#FB3","#F80","#F44","#C00"],l=0;l<o[e].length;l++)for(var r=0;r<o[e][l].length;r++)if(1==o[e][l][r]){var h={x:14*(i+2)*t+2*r*(i+1)+(i+1),y:2*l*(i+1)+(i+1),stepX:Math.floor(4*Math.random()-2),stepY:-2*n[Math.floor(Math.random()*n.length)],color:a[Math.floor(Math.random()*a.length)],disY:1};f.push(h)}}t=/(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date),r.push(t[1],t[2],10,t[3],t[4],10,t[5],t[6]),clearInterval(a);var a=setInterval(function(){!function(){var t=[],e=/(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date),n=[];n.push(e[1],e[2],10,e[3],e[4],10,e[5],e[6]);for(var a=r.length-1;0<=a;a--)n[a]!==r[a]&&t.push(a+"_"+(Number(r[a])+1)%10);for(a=0;a<t.length;a++)h.apply(this,t[a].split("_"));r=n.concat()}(),function(){for(var t=0;t<f.length;t++)f[t].stepY+=f[t].disY,f[t].x+=f[t].stepX,f[t].y+=f[t].stepY,(f[t].x>700+i||f[t].y>100+i)&&(f.splice(t,1),t--)}(),function(){e.height=100;for(var t=0;t<r.length;t++)n(t,r[t]);for(t=0;t<f.length;t++)l.beginPath(),l.arc(f[t].x,f[t].y,i,0,2*Math.PI),l.fillStyle=f[t].color,l.closePath(),l.fill()}()},50)}}()</script></div><div class="back-to-top motion-element"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2021</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">zqs菜鸡</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer></div><script size="300" alpha="0.6" zindex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script defer="defer" src="//cdn.jsdelivr.net/gh/theme-next/theme-next-three@1/three.min.js"></script><script defer="defer" src="//cdn.jsdelivr.net/gh/theme-next/theme-next-three@1/three-waves.min.js"></script><script src="/js/local-search.js"></script><script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script><script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script><script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'http://example.com/2021/06/13/modui-summary/',]
      });
      });
  </script><script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'Ttn6wpyi3PGFvGaXy67O0CB7-gzGzoHsz',
      appKey     : 'hVx8JDoum8iYxMFoDaum95Ih',
      placeholder: "stO Orz",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script><script type="text/javascript" src="/js/fold_action.js"></script><script type="text/javascript" src="/js/love.js"></script></body></html>