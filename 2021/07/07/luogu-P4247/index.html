<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"example.com",root:"/",scheme:"Gemini",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"mac"},back2top:{enable:!0,sidebar:!0,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.json"}</script><meta name="description" content="由于事奔着线段树来的所以跳过怎么想到线段树这一部分 看到这题，想到对于线段树的节点维护一个 $f$ 数组，$f_i$ 表示在该区间内选出 $i$ 个数相乘所有方案之和。"><meta property="og:type" content="article"><meta property="og:title" content="题解 【P4247 [清华集训2012]序列操作】"><meta property="og:url" content="http://example.com/2021/07/07/luogu-P4247/index.html"><meta property="og:site_name" content="zqs&#96;s blog"><meta property="og:description" content="由于事奔着线段树来的所以跳过怎么想到线段树这一部分 看到这题，想到对于线段树的节点维护一个 $f$ 数组，$f_i$ 表示在该区间内选出 $i$ 个数相乘所有方案之和。"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2021-07-07T05:30:37.000Z"><meta property="article:modified_time" content="2021-07-07T05:32:37.254Z"><meta property="article:author" content="zqs菜鸡"><meta property="article:tag" content="线段树"><meta name="twitter:card" content="summary"><link rel="canonical" href="http://example.com/2021/07/07/luogu-P4247/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>题解 【P4247 [清华集训2012]序列操作】 | zqs`s blog</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div> <a target="_blank" rel="noopener" href="https://github.com/ioiakzqs" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#70b7fd;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">zqs`s blog</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">有朋自远方来，虽远必诛</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2021/07/07/luogu-P4247/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="zqs菜鸡"><meta itemprop="description" content="反正是个菜鸡"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="zqs`s blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 题解 【P4247 [清华集训2012]序列操作】</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-07-07 13:30:37 / 修改时间：13:32:37" itemprop="dateCreated datePublished" datetime="2021-07-07T13:30:37+08:00">2021-07-07</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">数据结构</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span> <span class="post-meta-item-text">Valine：</span><a title="valine" href="/2021/07/07/luogu-P4247/#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2021/07/07/luogu-P4247/" itemprop="commentCount"></span></a></span></div></header><div class="post-body" itemprop="articleBody"><p><del>由于事奔着线段树来的所以跳过怎么想到线段树这一部分</del></p><p>看到这题，想到对于线段树的节点维护一个 $f$ 数组，$f_i$ 表示在该区间内选出 $i$ 个数相乘所有方案之和。</p><span id="more"></span><p>则令 $ls$ 为左儿子，$rs$ 为右儿子，易得转移：</p><script type="math/tex;mode=display">f_i=ls.f_i+rs.f_i\sum\limits^{c-1}_{i=1}ls.f_i\cdot rs.f_{c-j}</script><p>修改操作，如果是区间反转直接把 $i$ 为奇数的 $f_i$ 取个相反数，重点在于区间加。</p><p>先考虑计算 $\prod^k_{i=1}(a_i+x)-\prod^k_{i=1}a_i$。</p><p>观察 $\prod^k_{i=1}(a_i+x)$ 的展开式，得到上式等于 $\sum\limits^k_{i=1}x_i\cdot g_{k-i}$</p><p>$g_i$ 表示在 $a_1…a_k$ 中选出 $i$ 个数相乘的所有方案总和。</p><p>由于在一个线段树节点对应的区间中有很多长度为 $k$ 的区间，显然不能一一计算 $g$ 数组，由于 $f,g$ 定义非常相似，考虑利用 $f$ 推导 $g$。</p><p>其实可以得到，对于一个区间 $[l,r]$，$f_i=\sum\limits_{p_1,p_2..p_k\in [l,r]}\prod^k_{i=1}(a_{p_i}+x)-\prod^k_{i=1}a_{p_i}$。</p><p>也就是说，我们其实要计算：从 $[l,r]$ 区间中选出一个长度为 $k$ 的子序列，再从中选出一个长度为 $k-i$ 的子序列，计算这些子序列所有数的乘积之和。</p><p>假设 $[l,r]$ 区间长度为 $n$。</p><p>直接选出 $k-i$ 个数有 $\tbinom{n}{k-i}$ 种方案，按照上述方式选择有 $\tbinom{n}{k}\tbinom{k}{k-i}$ 种方案，即每种在区间 $[l,r]$ 直接选子序列的每种方案都被计算了 $\frac{\tbinom{n}{k}\tbinom{k}{k-i}}{\tbinom{n}{i}}=\tbinom{n-k+i}{i}$ 种方案。</p><p>那么最终答案就是，将区间 $[l,r]$ 加上一个数 $x$ 后，$f_k$ 会增加</p><script type="math/tex;mode=display">\sum\limits^{i\le k}_{i=1}x_i\cdot \tbinom{n-k+i}{i}\cdot f_{k-i}</script><p>那么本题唯一的难点区间加操作就解决了。</p><p>区间查询按照最开始提到的转移搞一搞就行了，由于需要返回一个数组注意及时 <code>delete</code> 亿些空间防止内存泄漏（其实我没<code>delete</code>完，但足以应付这题的空间限制）。</p><p>最后注意懒标记，我<code>pushdown</code>时先考虑反转标记再考虑加法标记，那么每次一个节点收到反转标记时都要将它的加法标记取相反数。</p><p>出人意料的是这题虽然代码不短但很好写（</p><div><div class="fold_hider"><div class="close hider_title">代码</div></div><div class="fold"><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> int long long</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">min</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> x, <span class="keyword">const</span> <span class="keyword">int</span> y)</span> </span>&#123;<span class="keyword">return</span> x &lt; y ? x : y;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> mod = <span class="number">19940417</span>;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> l, r, n, c[<span class="number">21</span>], Lazy;</span><br><span class="line">	<span class="keyword">bool</span> rev;</span><br><span class="line">&#125; tree[<span class="number">200005</span>];</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">int</span>* Array;</span><br><span class="line"><span class="keyword">int</span> a[<span class="number">50005</span>], C[<span class="number">50005</span>][<span class="number">21</span>], n, q;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pushup</span><span class="params">(<span class="keyword">int</span> O)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="built_in">min</span>(<span class="number">20</span>, tree[O].n); ++ i) &#123;</span><br><span class="line">		tree[O].c[i] = tree[O &lt;&lt; <span class="number">1</span>].c[i] + tree[O &lt;&lt; <span class="number">1</span> | <span class="number">1</span>].c[i];</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt; i; ++ j)</span><br><span class="line">			tree[O].c[i] = (tree[O].c[i] + tree[O &lt;&lt; <span class="number">1</span>].c[j] * tree[O &lt;&lt; <span class="number">1</span> | <span class="number">1</span>].c[i - j]) % mod;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reverse</span><span class="params">(<span class="keyword">int</span> O)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="built_in">min</span>(<span class="number">20</span>, tree[O].n); i += <span class="number">2</span>)</span><br><span class="line">		tree[O].c[i] = -tree[O].c[i];</span><br><span class="line">	tree[O].Lazy = -tree[O].Lazy;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> O, <span class="keyword">int</span> d)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="built_in">min</span>(<span class="number">20</span>, tree[O].n); i; -- i) &#123;</span><br><span class="line">		<span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>, x = d; j &lt;= i; ++ j, x = x * d % mod)</span><br><span class="line">			ret = (ret + x * C[tree[O].n - i + j][j] % mod * tree[O].c[i - j]) % mod;</span><br><span class="line">		tree[O].c[i] = (tree[O].c[i] + ret);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pushdown</span><span class="params">(<span class="keyword">int</span> O)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (tree[O].rev) &#123;</span><br><span class="line">		tree[O &lt;&lt; <span class="number">1</span>].rev ^= <span class="number">1</span>, tree[O &lt;&lt; <span class="number">1</span> | <span class="number">1</span>].rev ^= <span class="number">1</span>;</span><br><span class="line">		<span class="built_in">reverse</span>(O &lt;&lt; <span class="number">1</span>), <span class="built_in">reverse</span>(O &lt;&lt; <span class="number">1</span> | <span class="number">1</span>);</span><br><span class="line">		tree[O].rev = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (tree[O].Lazy) &#123;</span><br><span class="line">		tree[O &lt;&lt; <span class="number">1</span>].Lazy += tree[O].Lazy, tree[O &lt;&lt; <span class="number">1</span> | <span class="number">1</span>].Lazy += tree[O].Lazy;</span><br><span class="line">		<span class="built_in">add</span>(O &lt;&lt; <span class="number">1</span>, tree[O].Lazy), <span class="built_in">add</span>(O &lt;&lt; <span class="number">1</span> | <span class="number">1</span>, tree[O].Lazy);</span><br><span class="line">		tree[O].Lazy = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">make_tree</span><span class="params">(<span class="keyword">int</span> O, <span class="keyword">int</span> L, <span class="keyword">int</span> R)</span> </span>&#123;</span><br><span class="line">	tree[O].l = L, tree[O].r = R, tree[O].n = R - L + <span class="number">1</span>, tree[O].c[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span> (L != R) &#123;</span><br><span class="line">		<span class="built_in">make_tree</span>(O &lt;&lt; <span class="number">1</span>, L, L + R &gt;&gt; <span class="number">1</span>);</span><br><span class="line">		<span class="built_in">make_tree</span>(O &lt;&lt; <span class="number">1</span> | <span class="number">1</span>, (L + R &gt;&gt; <span class="number">1</span>) + <span class="number">1</span>, R);</span><br><span class="line">		<span class="built_in">pushup</span>(O);</span><br><span class="line">	&#125; <span class="keyword">else</span> tree[O].c[<span class="number">1</span>] = a[L];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">int</span> O, <span class="keyword">int</span> L, <span class="keyword">int</span> R, <span class="keyword">int</span> d)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (L &lt;= tree[O].l &amp;&amp; tree[O].r &lt;= R) &#123;</span><br><span class="line">		<span class="built_in">add</span>(O, d), tree[O].Lazy += d; <span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> mid = tree[O].l + tree[O].r &gt;&gt; <span class="number">1</span>;</span><br><span class="line">	<span class="built_in">pushdown</span>(O);</span><br><span class="line">	<span class="keyword">if</span> (L &lt;= mid) <span class="built_in">update</span>(O &lt;&lt; <span class="number">1</span>, L, R, d);</span><br><span class="line">	<span class="keyword">if</span> (mid &lt; R) <span class="built_in">update</span>(O &lt;&lt; <span class="number">1</span> | <span class="number">1</span>, L, R, d);</span><br><span class="line">	<span class="built_in">pushup</span>(O);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Reverse</span><span class="params">(<span class="keyword">int</span> O, <span class="keyword">int</span> L, <span class="keyword">int</span> R)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (L &lt;= tree[O].l &amp;&amp; tree[O].r &lt;= R) &#123;</span><br><span class="line">		<span class="built_in">reverse</span>(O), tree[O].rev ^= <span class="number">1</span>; <span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">int</span> mid = tree[O].l + tree[O].r &gt;&gt; <span class="number">1</span>;</span><br><span class="line">	<span class="built_in">pushdown</span>(O);</span><br><span class="line">	<span class="keyword">if</span> (L &lt;= mid) <span class="built_in">Reverse</span>(O &lt;&lt; <span class="number">1</span>, L, R);</span><br><span class="line">	<span class="keyword">if</span> (mid &lt; R) <span class="built_in">Reverse</span>(O &lt;&lt; <span class="number">1</span> | <span class="number">1</span>, L, R);</span><br><span class="line">	<span class="built_in">pushup</span>(O);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">Array <span class="title">query</span><span class="params">(<span class="keyword">int</span> O, <span class="keyword">int</span> L, <span class="keyword">int</span> R)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (L &lt;= tree[O].l &amp;&amp; tree[O].r &lt;= R) &#123;</span><br><span class="line">		<span class="keyword">int</span>* c = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">21</span>];</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">20</span>; ++ i) c[i] = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="built_in">min</span>(<span class="number">20</span>, tree[O].n); ++ i) c[i] = tree[O].c[i];</span><br><span class="line">		<span class="keyword">return</span> c;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">pushdown</span>(O);</span><br><span class="line">	<span class="keyword">int</span> mid = tree[O].l + tree[O].r &gt;&gt; <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span> (mid &gt;= R) <span class="keyword">return</span> <span class="built_in">query</span>(O &lt;&lt; <span class="number">1</span>, L, R);</span><br><span class="line">	<span class="keyword">if</span> (L &gt; mid) <span class="keyword">return</span> <span class="built_in">query</span>(O &lt;&lt; <span class="number">1</span> | <span class="number">1</span>, L, R);</span><br><span class="line">	<span class="keyword">int</span> *a = <span class="built_in">query</span>(O &lt;&lt; <span class="number">1</span>, L, R), *b = <span class="built_in">query</span>(O &lt;&lt; <span class="number">1</span> | <span class="number">1</span>, L, R), *c = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">21</span>];</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">20</span>; ++ i) c[i] = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= <span class="built_in">min</span>(<span class="number">20</span>, tree[O].n); ++ i) &#123;</span><br><span class="line">		c[i] = a[i] + b[i];</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt; i; ++ j) c[i] = (c[i] + a[j] * b[i - j] % mod) % mod;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">delete</span> a, <span class="keyword">delete</span> b;</span><br><span class="line">	<span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">signed</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="built_in">scanf</span>(<span class="string">&quot;%lld%lld&quot;</span>, &amp;n, &amp;q);</span><br><span class="line">	C[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt;= n; ++ i) &#123;</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot;%lld&quot;</span>, a + i);</span><br><span class="line">		C[i][<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt;= <span class="built_in">min</span>(i, <span class="number">20</span>); ++ j)</span><br><span class="line">			C[i][j] = (C[i - <span class="number">1</span>][j - <span class="number">1</span>] + C[i - <span class="number">1</span>][j]) % mod;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">make_tree</span>(<span class="number">1</span>, <span class="number">1</span>, n);</span><br><span class="line">	<span class="keyword">while</span> (q --) &#123;</span><br><span class="line">		<span class="keyword">char</span> opt;</span><br><span class="line">		<span class="keyword">int</span> l, r, v;</span><br><span class="line">		<span class="built_in">scanf</span>(<span class="string">&quot; %c%lld%lld&quot;</span>, &amp;opt, &amp;l, &amp;r);</span><br><span class="line">		<span class="keyword">if</span> (opt == <span class="string">&#x27;I&#x27;</span>) <span class="built_in">scanf</span>(<span class="string">&quot;%lld&quot;</span>, &amp;v), <span class="built_in">update</span>(<span class="number">1</span>, l, r, v);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (opt == <span class="string">&#x27;R&#x27;</span>) <span class="built_in">Reverse</span>(<span class="number">1</span>, l, r);</span><br><span class="line">		<span class="keyword">else</span> <span class="built_in">scanf</span>(<span class="string">&quot;%lld&quot;</span>, &amp;v), <span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>, (<span class="built_in">query</span>(<span class="number">1</span>, l, r)[v] + mod) % mod);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></div></div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> zqs菜鸡</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="http://example.com/2021/07/07/luogu-P4247/" title="题解 【P4247 [清华集训2012]序列操作】">http://example.com/2021/07/07/luogu-P4247/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/%E7%BA%BF%E6%AE%B5%E6%A0%91/" rel="tag"><i class="fa fa-tag"></i> 线段树</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2021/07/03/luogu-P5071/" rel="prev" title="题解 【P5071 [Ynoi2015] 此时此刻的光辉】"><i class="fa fa-chevron-left"></i> 题解 【P5071 [Ynoi2015] 此时此刻的光辉】</a></div><div class="post-nav-item"> <a href="/2021/07/09/luogu-P3159/" rel="next" title="题解 【P3159 [CQOI2012]交换棋子】">题解 【P3159 [CQOI2012]交换棋子】<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="valine-comments"></div><script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">zqs菜鸡</p><div class="site-description" itemprop="description">反正是个菜鸡</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">74</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">13</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">37</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/ioiakzqs" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ioiakzqs" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="https://gitee.com/zqs2020" title="Gitee → https:&#x2F;&#x2F;gitee.com&#x2F;zqs2020" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> Gitee</a></span><span class="links-of-author-item"><a href="https://blog.csdn.net/jvruo_shabi" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;jvruo_shabi" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i> CSDN</a></span><span class="links-of-author-item"><a href="https://www.luogu.com.cn/user/361308" title="洛谷 → https:&#x2F;&#x2F;www.luogu.com.cn&#x2F;user&#x2F;361308" rel="noopener" target="_blank"><i class="fa fa-fw fa-code"></i> 洛谷</a></span></div><div class="cc-license motion-element" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a></div><div style=""><canvas id="canvas" style="width:60%">当前浏览器不支持canvas，请更换浏览器后再试</canvas></div><script>!function(){var t,o=[[[0,0,1,1,1,0,0],[0,1,1,0,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,0,1,1,0],[0,0,1,1,1,0,0]],[[0,0,0,1,1,0,0],[0,1,1,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[1,1,1,1,1,1,1]],[[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,0,1,1,0,0,0],[0,1,1,0,0,0,0],[1,1,0,0,0,0,0],[1,1,0,0,0,1,1],[1,1,1,1,1,1,1]],[[1,1,1,1,1,1,1],[0,0,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,0,1,1,0],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[0,0,0,0,1,1,0],[0,0,0,1,1,1,0],[0,0,1,1,1,1,0],[0,1,1,0,1,1,0],[1,1,0,0,1,1,0],[1,1,1,1,1,1,1],[0,0,0,0,1,1,0],[0,0,0,0,1,1,0],[0,0,0,0,1,1,0],[0,0,0,1,1,1,1]],[[1,1,1,1,1,1,1],[1,1,0,0,0,0,0],[1,1,0,0,0,0,0],[1,1,1,1,1,1,0],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[0,0,0,0,1,1,0],[0,0,1,1,0,0,0],[0,1,1,0,0,0,0],[1,1,0,0,0,0,0],[1,1,0,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[1,1,1,1,1,1,1],[1,1,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,1,1,0,0,0],[0,0,1,1,0,0,0],[0,0,1,1,0,0,0],[0,0,1,1,0,0,0]],[[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,1,1,0,0,0,0]],[[0,0,0,0,0,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,0,0,0,0]]],e=document.getElementById("canvas");if(e.getContext){var l=e.getContext("2d");e.height=100,e.width=700,l.fillStyle="#f00",l.fillRect(10,10,50,50);var r=[],f=[],i=e.height/20-1;function n(t,e){for(var n=0;n<o[e].length;n++)for(var a=0;a<o[e][n].length;a++)1==o[e][n][a]&&(l.beginPath(),l.arc(14*(i+2)*t+2*a*(i+1)+(i+1),2*n*(i+1)+(i+1),i,0,2*Math.PI),l.closePath(),l.fill())}function h(t,e){for(var n=[1,2,3],a=["#3BE","#09C","#A6C","#93C","#9C0","#690","#FB3","#F80","#F44","#C00"],l=0;l<o[e].length;l++)for(var r=0;r<o[e][l].length;r++)if(1==o[e][l][r]){var h={x:14*(i+2)*t+2*r*(i+1)+(i+1),y:2*l*(i+1)+(i+1),stepX:Math.floor(4*Math.random()-2),stepY:-2*n[Math.floor(Math.random()*n.length)],color:a[Math.floor(Math.random()*a.length)],disY:1};f.push(h)}}t=/(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date),r.push(t[1],t[2],10,t[3],t[4],10,t[5],t[6]),clearInterval(a);var a=setInterval(function(){!function(){var t=[],e=/(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date),n=[];n.push(e[1],e[2],10,e[3],e[4],10,e[5],e[6]);for(var a=r.length-1;0<=a;a--)n[a]!==r[a]&&t.push(a+"_"+(Number(r[a])+1)%10);for(a=0;a<t.length;a++)h.apply(this,t[a].split("_"));r=n.concat()}(),function(){for(var t=0;t<f.length;t++)f[t].stepY+=f[t].disY,f[t].x+=f[t].stepX,f[t].y+=f[t].stepY,(f[t].x>700+i||f[t].y>100+i)&&(f.splice(t,1),t--)}(),function(){e.height=100;for(var t=0;t<r.length;t++)n(t,r[t]);for(t=0;t<f.length;t++)l.beginPath(),l.arc(f[t].x,f[t].y,i,0,2*Math.PI),l.fillStyle=f[t].color,l.closePath(),l.fill()}()},50)}}()</script></div><div class="back-to-top motion-element"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2021</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">zqs菜鸡</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer></div><script size="300" alpha="0.6" zindex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script defer="defer" src="//cdn.jsdelivr.net/gh/theme-next/theme-next-three@1/three.min.js"></script><script defer="defer" src="//cdn.jsdelivr.net/gh/theme-next/theme-next-three@1/three-waves.min.js"></script><script src="/js/local-search.js"></script><script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script><script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script><script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'http://example.com/2021/07/07/luogu-P4247/',]
      });
      });
  </script><script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'Ttn6wpyi3PGFvGaXy67O0CB7-gzGzoHsz',
      appKey     : 'hVx8JDoum8iYxMFoDaum95Ih',
      placeholder: "stO Orz",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script><script type="text/javascript" src="/js/fold_action.js"></script><script type="text/javascript" src="/js/love.js"></script></body></html>