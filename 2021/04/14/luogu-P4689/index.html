<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"example.com",root:"/",scheme:"Gemini",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"mac"},back2top:{enable:!0,sidebar:!0,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.json"}</script><meta name="description" content="大家好，我是来拉低这题通过率的"><meta property="og:type" content="article"><meta property="og:title" content="题解 【P4689 [Ynoi2016] 这是我自己的发明】"><meta property="og:url" content="http://example.com/2021/04/14/luogu-P4689/index.html"><meta property="og:site_name" content="zqs&#96;s blog"><meta property="og:description" content="大家好，我是来拉低这题通过率的"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2021-04-14T04:53:59.000Z"><meta property="article:modified_time" content="2021-04-14T04:57:32.989Z"><meta property="article:author" content="zqs菜鸡"><meta property="article:tag" content="莫队"><meta name="twitter:card" content="summary"><link rel="canonical" href="http://example.com/2021/04/14/luogu-P4689/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>题解 【P4689 [Ynoi2016] 这是我自己的发明】 | zqs`s blog</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div> <a target="_blank" rel="noopener" href="https://github.com/ioiakzqs" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#70b7fd;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">zqs`s blog</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">有朋自远方来，虽远必诛</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://example.com/2021/04/14/luogu-P4689/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.gif"><meta itemprop="name" content="zqs菜鸡"><meta itemprop="description" content="反正是个菜鸡"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="zqs`s blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 题解 【P4689 [Ynoi2016] 这是我自己的发明】</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-04-14 12:53:59 / 修改时间：12:57:32" itemprop="dateCreated datePublished" datetime="2021-04-14T12:53:59+08:00">2021-04-14</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">数据结构</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span> <span class="post-meta-item-text">Valine：</span><a title="valine" href="/2021/04/14/luogu-P4689/#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/2021/04/14/luogu-P4689/" itemprop="commentCount"></span></a></span></div></header><div class="post-body" itemprop="articleBody"><p><del>大家好，我是来拉低这题通过率的</del></p><span id="more"></span><p>这个题有一个弱化版<a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P5268">P5268</a>。在这里简单地讲一下这个弱化版。</p><p>就是设 $f(l_1,l_2,r_1,r_2)$ 表示区间 $[l_1,l_2]$ 与 $[r_1,r_2]$ 的答案。那么容斥一下或者暴力展开式子（像下面这样，$g(l,r,x)$ 表示区间 $[l,r]$ 内 $x$ 出现的次数）。</p><script type="math/tex;mode=display">
\begin{aligned}
f(l_1,l_2,r_1,r_2)&=\sum\limits^{\infty}_{i=1}g(l_1,r_1,i)\times g(l_2,r_2,i)\\
&=\sum\limits^{\infty}_{i=1}[g(1,r_1,i)-g(1,l_1-1,i)]\times [g(1,r_2,i)-g(1,l_2-1,i)]\\
&=\sum\limits^{\infty}_{i=1}g(1,l_1,i)\times g(1,r_2,i)-g(1,l_1-1,i)\times g(1,r_2,i)-g(1,r_1,i)\times g(1,l_2-1,i)+g(1,l_1-1,i)\times g(1,r_2-1,i)\\
&=f(1,1,r_1,r_2)-f(1,1,l_1-1,r_2)-f(1,1,l_2-1,r_1)+f(1,1,l_1-1,r_1-1)
\end{aligned}</script><p>然后上个莫队就可以了。</p><p>这题有两个地方加强了：</p><ol><li><p>原问题搬到了树上</p></li><li><p>数据范围扩大，<del>然而仍然是Ynoi少有的不卡常的良心题</del></p></li></ol><p>那么怎么把序列上的题搬到树上呢？</p><p>一个可行的做法是dfs序。换根操作是个非常套路的dfs序自带功能，分类讨论一下：</p><ol><li><p>$u$ 是 $root$，$u$ 对应的就是整个区间。</p></li><li><p>$u$ 不是 $root$ 也不是 $root$ 的祖先，对应的区间就是 $[In_u,Out_u]$。</p></li><li><p>$u$ 不是 $root$ 且是 $root$ 的祖先。这种情况稍微麻烦一点，假设 $u$ 向 $root$ 方向的儿子是 $v$，那么对应的区间是 $[1,In_y)$ 和 $(Out_y+1,n)$ 两段区间。</p></li></ol><p>然后就可以强行拆成膜队了。</p><p>但是注意直接拆最多会拆成 $16$ 个询问，<del>根据lxl的凉心程度，这辈子都不可能放你过的（</del></p><p>为了<del>少打几个字</del>方便表述设 $f_0(x,y)=f(1,1,x,y)$</p><p>但是 $f_0$ 函数当 $x$ 或 $y$ 为 $0$ 时值为 $0$，然后就只有 $9$ 个膜队了！！！！！！11</p><p><del>不好意思，根据膜队的复杂度这样只会让常数除以1.4</del></p><p>然鹅拆成的询问很多 $f_0$ 函数 都是 $f_0(i,n)$ 的，我们让 $g_i$ 表示 $f_0(i,n)$，然后就只需要拆成 $4$ 个询问了！！！！！！！！！！1111（雾</p><p>放一下最后展开的式子：</p><p>$f(1,l,x,r)+f(y,l,n,r)=f_0(x,r)-f_0(l-1,x)+f_0(y-1,l-1)-f_0(y-1,r)-g_{l-1}+g_r$</p><p>$f(1,1,x_0,x_1)+f(1,y,x_0,n)+f(y_0,1,n,x_1)+f(y_0,y_1,n,n)=f_0(x_0,x_1)+g_{x_0}-f_0(y_1-1,x_0)+g-{x_1}-f_0(y_0-1,x_1)-g_{y_1-1}-g_{y_0-1}+g_n+f_0(y_0-1,y_1-1)-g_{y_0-1}-g_{y_1-1}$</p><p><del>不是很长对吧</del></p><p>然后，对于如何找点 $u$ 在 $v$ 方向的儿子，当然倍增是可以的，但是有一个更简单的方法，就是记录 $u$ 所有儿子的 $In$ 值，查询的时候直接二分查找就行了。详见带马。</p><p>最后的复杂度 $O(n\sqrt{m})$。注意膜队的正确块长是 $n\div \sqrt{m}$，否则复杂度会退化。</p><p><del>祝愿没有人像我一样为本题无私地贡献36次提交。</del></p><p>还有，十年OI一场空，不开<strong>__</strong>见祖宗（（（</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cmath&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> gc (p1 == p2 &amp;&amp; (p2 = (p1 = buf) + fread(buf, 1, 65536, stdin), p1 == p2) ? EOF : *p1 ++)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">long</span> <span class="keyword">long</span> ll;</span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">65536</span>], *p1, *p2;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">char</span> ch;</span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">x</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br><span class="line">	<span class="keyword">while</span> ((ch = gc) &lt; <span class="number">48</span>);</span><br><span class="line">	<span class="keyword">do</span> x = x * <span class="number">10</span> + ch - <span class="number">48</span>; <span class="keyword">while</span> ((ch = gc) &gt;= <span class="number">48</span>);</span><br><span class="line">	<span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> a[<span class="number">100005</span>], A[<span class="number">100005</span>], cnt[<span class="number">100005</span>][<span class="number">2</span>], In[<span class="number">100005</span>], Out[<span class="number">100005</span>], P[<span class="number">100005</span>];</span><br><span class="line"><span class="keyword">int</span> Now, S, tot, <span class="built_in">root</span>(<span class="number">1</span>);</span><br><span class="line">ll g[<span class="number">100005</span>], Q[<span class="number">500005</span>], ans;</span><br><span class="line">std::vector&lt;<span class="keyword">int</span>&gt; sons[<span class="number">100005</span>], dfn[<span class="number">100005</span>];</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">chk</span><span class="params">(<span class="keyword">int</span> u)</span> </span>&#123;<span class="keyword">return</span> In[u] &lt; In[root] &amp;&amp; Out[root] &lt;= Out[u];&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">getance</span><span class="params">(<span class="keyword">int</span> u)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> P[*(std::<span class="built_in">upper_bound</span>(dfn[u].<span class="built_in">begin</span>(), dfn[u].<span class="built_in">end</span>(), In[root]) - <span class="number">1</span>)];</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Question</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span> op, id, l, r;</span><br><span class="line">	<span class="keyword">inline</span> <span class="keyword">bool</span> <span class="keyword">operator</span> &lt; (<span class="keyword">const</span> Question a) <span class="keyword">const</span> &#123;</span><br><span class="line">		int x((l - 1) / S), y((a.l - 1) / S);</span><br><span class="line">		<span class="keyword">return</span> x == y ? (r - <span class="number">1</span>) / S &lt; (a.r - <span class="number">1</span>) / S : x &lt; y;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; q[<span class="number">2000005</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> x, <span class="keyword">const</span> <span class="keyword">int</span> d)</span> </span>&#123;</span><br><span class="line">	ans += cnt[x][d ^ <span class="number">1</span>], ++ cnt[x][d];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">del</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> x, <span class="keyword">const</span> <span class="keyword">int</span> d)</span> </span>&#123;</span><br><span class="line">	ans -= cnt[x][d ^ <span class="number">1</span>], -- cnt[x][d];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">const</span> <span class="keyword">int</span> u, <span class="keyword">const</span> <span class="keyword">int</span> fa)</span> </span>&#123;</span><br><span class="line">	P[In[u] = ++ Now] = u;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> v : sons[u])</span><br><span class="line">		<span class="keyword">if</span> (v != fa) <span class="built_in">dfs</span>(v, u), dfn[u].<span class="built_in">push_back</span>(In[v]);</span><br><span class="line">	Out[u] = Now;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> n, m, <span class="built_in">l</span>(<span class="number">0</span>), <span class="built_in">r</span>(<span class="number">0</span>), <span class="built_in">qid</span>(<span class="number">0</span>);</span><br><span class="line">	n = <span class="built_in">read</span>(), m = <span class="built_in">read</span>();</span><br><span class="line">	S = n / <span class="built_in">sqrt</span>(m);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> <span class="built_in">i</span>(<span class="number">1</span>); i &lt;= n; ++ i) A[i] = a[i] = <span class="built_in">read</span>();</span><br><span class="line">	std::<span class="built_in">sort</span>(a + <span class="number">1</span>, a + n + <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> <span class="built_in">i</span>(<span class="number">1</span>); i &lt;= n; ++ i)</span><br><span class="line">		A[i] = std::<span class="built_in">lower_bound</span>(a + <span class="number">1</span>, a + n + <span class="number">1</span>, A[i]) - a;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> <span class="built_in">i</span>(<span class="number">1</span>); i &lt; n; ++ i) &#123;</span><br><span class="line">		int u(read()), v(read());</span><br><span class="line">		sons[u].<span class="built_in">push_back</span>(v), sons[v].<span class="built_in">push_back</span>(u);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">dfs</span>(<span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> <span class="built_in">i</span>(<span class="number">1</span>); i &lt;= n; ++ i) ++ cnt[a[In[i]] = A[i]][<span class="number">0</span>];</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> <span class="built_in">i</span>(<span class="number">1</span>); i &lt;= n; ++ i) g[i] = g[i - <span class="number">1</span>] + cnt[a[i]][<span class="number">0</span>];</span><br><span class="line">	<span class="built_in">memset</span>(cnt, <span class="number">0</span>, <span class="keyword">sizeof</span> cnt);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> <span class="built_in">i</span>(<span class="number">1</span>); i &lt;= m; ++ i) &#123;</span><br><span class="line">		<span class="function"><span class="keyword">int</span> <span class="title">op</span><span class="params">(read())</span></span>;</span><br><span class="line">		<span class="keyword">if</span> (op == <span class="number">1</span>) root = <span class="built_in">read</span>();</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			++ qid;</span><br><span class="line">			int u(read()), v(read());</span><br><span class="line">			<span class="keyword">if</span> (!<span class="built_in">chk</span>(u) &amp;&amp; <span class="built_in">chk</span>(v)) std::<span class="built_in">swap</span>(u, v);</span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> <span class="built_in">j</span>(<span class="number">1</span>); j &lt;= <span class="number">4</span>; ++ j) q[tot + j].id = qid;</span><br><span class="line">			<span class="keyword">if</span> (!<span class="built_in">chk</span>(u) &amp;&amp; !<span class="built_in">chk</span>(v)) &#123;</span><br><span class="line">				int l1(In[u]), r1(Out[u]), l2(In[v]), r2(Out[v]);</span><br><span class="line">				<span class="keyword">if</span> (u == root) l1 = <span class="number">1</span>, r1 = n;</span><br><span class="line">				<span class="keyword">if</span> (v == root) l2 = <span class="number">1</span>, r2 = n;</span><br><span class="line">				q[++ tot].op = <span class="number">1</span>, q[tot].l = r1, q[tot].r = r2;</span><br><span class="line">				q[++ tot].op = <span class="number">-1</span>, q[tot].l = l1 - <span class="number">1</span>, q[tot].r = r2;</span><br><span class="line">				q[++ tot].op = <span class="number">-1</span>, q[tot].l = l2 - <span class="number">1</span>, q[tot].r = r1;</span><br><span class="line">				q[++ tot].op = <span class="number">1</span>, q[tot].l = l1 - <span class="number">1</span>, q[tot].r = l2 - <span class="number">1</span>;</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">chk</span>(u) &amp;&amp; !<span class="built_in">chk</span>(v)) &#123;</span><br><span class="line">				<span class="keyword">int</span> <span class="built_in">t</span>(<span class="built_in">getance</span>(u));</span><br><span class="line">				int x(In[t] - 1), y(Out[t] + 1), l(In[v]), r(Out[v]);</span><br><span class="line">				<span class="keyword">if</span> (v == root) l = <span class="number">1</span>, r = n;</span><br><span class="line">				Q[qid] = g[r] - g[l - <span class="number">1</span>];</span><br><span class="line">				q[++ tot].op = <span class="number">1</span>, q[tot].l = x, q[tot].r = r;</span><br><span class="line">				q[++ tot].op = <span class="number">-1</span>, q[tot].l = l - <span class="number">1</span>, q[tot].r = x;</span><br><span class="line">				q[++ tot].op = <span class="number">1</span>, q[tot].l = y - <span class="number">1</span>, q[tot].r = l - <span class="number">1</span>;</span><br><span class="line">				q[++ tot].op = <span class="number">-1</span>, q[tot].l = y - <span class="number">1</span>, q[tot].r = r;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">int</span> <span class="built_in">t1</span>(<span class="built_in">getance</span>(u)), <span class="built_in">t2</span>(<span class="built_in">getance</span>(v));</span><br><span class="line">				int x0(In[t1] - 1), x1(In[t2] - 1), y0(Out[t1] + 1), y1(Out[t2] + 1);</span><br><span class="line">				Q[qid] = g[x0] + g[x1] - g[y1 - <span class="number">1</span>] - g[y0 - <span class="number">1</span>] + g[n];</span><br><span class="line">				q[++ tot].op = <span class="number">1</span>, q[tot].l = x0, q[tot].r = x1;</span><br><span class="line">				q[++ tot].op = <span class="number">-1</span>, q[tot].l = y1 - <span class="number">1</span>, q[tot].r = x0;</span><br><span class="line">				q[++ tot].op = <span class="number">-1</span>, q[tot].l = y0 - <span class="number">1</span>, q[tot].r = x1;</span><br><span class="line">				q[++ tot].op = <span class="number">1</span>, q[tot].l = y0 - <span class="number">1</span>, q[tot].r = y1 - <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> <span class="built_in">i</span>(<span class="number">1</span>); i &lt;= tot; ++ i)</span><br><span class="line">		<span class="keyword">if</span> (q[i].l &gt; q[i].r) std::<span class="built_in">swap</span>(q[i].l, q[i].r);</span><br><span class="line">	std::<span class="built_in">sort</span>(q + <span class="number">1</span>, q + tot + <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> <span class="built_in">i</span>(<span class="number">1</span>); i &lt;= tot; ++ i) &#123;</span><br><span class="line">		<span class="keyword">while</span> (l &lt; q[i].l) <span class="built_in">add</span>(a[++ l], <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">while</span> (l &gt; q[i].l) <span class="built_in">del</span>(a[l --], <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">while</span> (r &lt; q[i].r) <span class="built_in">add</span>(a[++ r], <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">while</span> (r &gt; q[i].r) <span class="built_in">del</span>(a[r --], <span class="number">1</span>);</span><br><span class="line">		Q[q[i].id] += q[i].op * ans;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> <span class="built_in">i</span>(<span class="number">1</span>); i &lt;= qid; ++ i) <span class="built_in">printf</span>(<span class="string">&quot;%lld\n&quot;</span>, Q[i]);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div><div><ul class="post-copyright"><li class="post-copyright-author"> <strong>本文作者：</strong> zqs菜鸡</li><li class="post-copyright-link"> <strong>本文链接：</strong> <a href="http://example.com/2021/04/14/luogu-P4689/" title="题解 【P4689 [Ynoi2016] 这是我自己的发明】">http://example.com/2021/04/14/luogu-P4689/</a></li><li class="post-copyright-license"> <strong>版权声明：</strong> 本博客所有文章除特别声明外，均采用<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i> BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/%E8%8E%AB%E9%98%9F/" rel="tag"><i class="fa fa-tag"></i> 莫队</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2021/04/11/luogu-P5268/" rel="prev" title="题解【P5268 [SNOI2017]一个简单的询问】"><i class="fa fa-chevron-left"></i> 题解【P5268 [SNOI2017]一个简单的询问】</a></div><div class="post-nav-item"> <a href="/2021/04/16/UVA-1658/" rel="next" title="题解 【UVA1658 海军上将 Admiral】">题解 【UVA1658 海军上将 Admiral】<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="valine-comments"></div><script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><p class="site-author-name" itemprop="name">zqs菜鸡</p><div class="site-description" itemprop="description">反正是个菜鸡</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">66</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">13</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">35</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/ioiakzqs" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ioiakzqs" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="https://gitee.com/zqs2020" title="Gitee → https:&#x2F;&#x2F;gitee.com&#x2F;zqs2020" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> Gitee</a></span><span class="links-of-author-item"><a href="https://blog.csdn.net/jvruo_shabi" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;jvruo_shabi" rel="noopener" target="_blank"><i class="fa fa-fw fa-book"></i> CSDN</a></span><span class="links-of-author-item"><a href="https://www.luogu.com.cn/user/361308" title="洛谷 → https:&#x2F;&#x2F;www.luogu.com.cn&#x2F;user&#x2F;361308" rel="noopener" target="_blank"><i class="fa fa-fw fa-code"></i> 洛谷</a></span></div><div class="cc-license motion-element" itemprop="license"> <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a></div><div style=""><canvas id="canvas" style="width:60%">当前浏览器不支持canvas，请更换浏览器后再试</canvas></div><script>!function(){var t,o=[[[0,0,1,1,1,0,0],[0,1,1,0,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,0,1,1,0],[0,0,1,1,1,0,0]],[[0,0,0,1,1,0,0],[0,1,1,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[1,1,1,1,1,1,1]],[[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,0,1,1,0,0,0],[0,1,1,0,0,0,0],[1,1,0,0,0,0,0],[1,1,0,0,0,1,1],[1,1,1,1,1,1,1]],[[1,1,1,1,1,1,1],[0,0,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,0,1,1,0],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[0,0,0,0,1,1,0],[0,0,0,1,1,1,0],[0,0,1,1,1,1,0],[0,1,1,0,1,1,0],[1,1,0,0,1,1,0],[1,1,1,1,1,1,1],[0,0,0,0,1,1,0],[0,0,0,0,1,1,0],[0,0,0,0,1,1,0],[0,0,0,1,1,1,1]],[[1,1,1,1,1,1,1],[1,1,0,0,0,0,0],[1,1,0,0,0,0,0],[1,1,1,1,1,1,0],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[0,0,0,0,1,1,0],[0,0,1,1,0,0,0],[0,1,1,0,0,0,0],[1,1,0,0,0,0,0],[1,1,0,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[1,1,1,1,1,1,1],[1,1,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,0,0,1,1,0,0],[0,0,1,1,0,0,0],[0,0,1,1,0,0,0],[0,0,1,1,0,0,0],[0,0,1,1,0,0,0]],[[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,1,1,0]],[[0,1,1,1,1,1,0],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[1,1,0,0,0,1,1],[0,1,1,1,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,0,1,1],[0,0,0,0,1,1,0],[0,0,0,1,1,0,0],[0,1,1,0,0,0,0]],[[0,0,0,0,0,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,0,0,0,0],[0,0,0,0,0,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,1,1,1,0,0],[0,0,0,0,0,0,0]]],e=document.getElementById("canvas");if(e.getContext){var l=e.getContext("2d");e.height=100,e.width=700,l.fillStyle="#f00",l.fillRect(10,10,50,50);var r=[],f=[],i=e.height/20-1;function n(t,e){for(var n=0;n<o[e].length;n++)for(var a=0;a<o[e][n].length;a++)1==o[e][n][a]&&(l.beginPath(),l.arc(14*(i+2)*t+2*a*(i+1)+(i+1),2*n*(i+1)+(i+1),i,0,2*Math.PI),l.closePath(),l.fill())}function h(t,e){for(var n=[1,2,3],a=["#3BE","#09C","#A6C","#93C","#9C0","#690","#FB3","#F80","#F44","#C00"],l=0;l<o[e].length;l++)for(var r=0;r<o[e][l].length;r++)if(1==o[e][l][r]){var h={x:14*(i+2)*t+2*r*(i+1)+(i+1),y:2*l*(i+1)+(i+1),stepX:Math.floor(4*Math.random()-2),stepY:-2*n[Math.floor(Math.random()*n.length)],color:a[Math.floor(Math.random()*a.length)],disY:1};f.push(h)}}t=/(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date),r.push(t[1],t[2],10,t[3],t[4],10,t[5],t[6]),clearInterval(a);var a=setInterval(function(){!function(){var t=[],e=/(\d)(\d):(\d)(\d):(\d)(\d)/.exec(new Date),n=[];n.push(e[1],e[2],10,e[3],e[4],10,e[5],e[6]);for(var a=r.length-1;0<=a;a--)n[a]!==r[a]&&t.push(a+"_"+(Number(r[a])+1)%10);for(a=0;a<t.length;a++)h.apply(this,t[a].split("_"));r=n.concat()}(),function(){for(var t=0;t<f.length;t++)f[t].stepY+=f[t].disY,f[t].x+=f[t].stepX,f[t].y+=f[t].stepY,(f[t].x>700+i||f[t].y>100+i)&&(f.splice(t,1),t--)}(),function(){e.height=100;for(var t=0;t<r.length;t++)n(t,r[t]);for(t=0;t<f.length;t++)l.beginPath(),l.arc(f[t].x,f[t].y,i,0,2*Math.PI),l.fillStyle=f[t].color,l.closePath(),l.fill()}()},50)}}()</script></div><div class="back-to-top motion-element"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2021</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">zqs菜鸡</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer></div><script size="300" alpha="0.6" zindex="-1" src="/lib/canvas-ribbon/canvas-ribbon.js"></script><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script defer="defer" src="//cdn.jsdelivr.net/gh/theme-next/theme-next-three@1/three.min.js"></script><script defer="defer" src="//cdn.jsdelivr.net/gh/theme-next/theme-next-three@1/three-waves.min.js"></script><script src="/js/local-search.js"></script><script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script><script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script><script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'http://example.com/2021/04/14/luogu-P4689/',]
      });
      });
  </script><script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'Ttn6wpyi3PGFvGaXy67O0CB7-gzGzoHsz',
      appKey     : 'hVx8JDoum8iYxMFoDaum95Ih',
      placeholder: "stO Orz",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script><script type="text/javascript" src="/js/fold_action.js"></script><script type="text/javascript" src="/js/love.js"></script></body></html>